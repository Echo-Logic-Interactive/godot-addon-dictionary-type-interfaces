name: CI - Lint, Format & Test

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened, ready_for_review]

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Skip CI for draft PRs (saves minutes during development)
  check-draft:
    name: Check if Draft PR
    runs-on: ubuntu-latest
    outputs:
      is_draft: ${{ steps.check.outputs.is_draft }}
    steps:
      - name: Check draft status
        id: check
        run: |
          if [ "${{ github.event.pull_request.draft }}" == "true" ]; then
            echo "is_draft=true" >> $GITHUB_OUTPUT
            echo "⏭️  Skipping CI for draft PR"
          else
            echo "is_draft=false" >> $GITHUB_OUTPUT
          fi

  gdscript-lint:
    name: GDScript Linting
    runs-on: ubuntu-latest
    needs: check-draft
    if: needs.check-draft.outputs.is_draft != 'true'
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install gdtoolkit
        run: pip install gdtoolkit

      - name: Run gdlint
        run: |
          echo "Running gdlint on all addon scripts..."
          gdlint --verbose .

  gdscript-format:
    name: GDScript Format Check
    runs-on: ubuntu-latest
    needs: check-draft
    if: needs.check-draft.outputs.is_draft != 'true'
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install gdtoolkit
        run: pip install gdtoolkit

      - name: Check formatting
        run: |
          echo "Checking code formatting..."
          gdformat --check .

  addon-structure:
    name: Addon Structure Validation
    runs-on: ubuntu-latest
    needs: check-draft
    if: needs.check-draft.outputs.is_draft != 'true'
    timeout-minutes: 3

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate required files
        run: |
          echo "Validating addon file structure..."

          required_files=(
            "plugin.cfg"
            "README.MD"
            "src/type_interfaces_plugin.gd"
            "src/type_interfaces_runtime.gd"
            "src/interface_modding_api.gd"
            "classes/TypedDict.gd"
            "classes/ExtendableInterface.gd"
            "classes/SchemaExporter.gd"
            "examples/IExamplePlayer.gd"
            "examples/IExampleItem.gd"
            "examples/IExampleQuest.gd"
            "examples/basic_usage_examples.gd"
            "examples/test_validation_ci.gd"
          )

          all_found=true
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing: $file"
              all_found=false
            else
              echo "✓ Found: $file"
            fi
          done

          if [ "$all_found" = false ]; then
            exit 1
          fi

          echo ""
          echo "✅ All required files present"

      - name: Validate plugin.cfg
        run: |
          echo "Validating plugin.cfg..."

          required_fields=("name" "description" "author" "version" "script")
          all_found=true

          for field in "${required_fields[@]}"; do
            if ! grep -q "^${field}=" plugin.cfg; then
              echo "❌ Missing field in plugin.cfg: $field"
              all_found=false
            else
              value=$(grep "^${field}=" plugin.cfg | cut -d'=' -f2- | tr -d '"')
              echo "✓ $field = $value"
            fi
          done

          if [ "$all_found" = false ]; then
            exit 1
          fi

          echo ""
          echo "✅ plugin.cfg validation passed"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [gdscript-lint, gdscript-format, addon-structure]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "╔════════════════════════════════════════╗"
          echo "║        CI Pipeline Summary             ║"
          echo "╚════════════════════════════════════════╝"
          echo ""
          echo "GDScript Linting:       ${{ needs.gdscript-lint.result }}"
          echo "Format Check:           ${{ needs.gdscript-format.result }}"
          echo "Addon Structure:        ${{ needs.addon-structure.result }}"
          echo ""

          if [ "${{ needs.gdscript-lint.result }}" != "success" ] || \
             [ "${{ needs.gdscript-format.result }}" != "success" ] || \
             [ "${{ needs.addon-structure.result }}" != "success" ]; then
            echo "❌ CI FAILED - Please check the logs above"
            exit 1
          else
            echo "✅ ALL CHECKS PASSED!"
          fi

# EOF
